<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simon & Frost App</title>

<!-- PWA META -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/192.png">

<style>
/* Global Reset */
body {
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: #f8fafc;
  color: #0f172a;
  max-width: 820px;
  margin: 0 auto;
  overflow-x: hidden;
}

/* Panels (tabs) */
.panel {
  display: none;
  padding: 32px 20px 100px 20px;
  animation-duration: .35s;
  animation-timing-function: ease-out;
}
.panel.active { display: block; }

.slide-in-right { animation-name: slideInRight; }
.slide-in-left { animation-name: slideInLeft; }

@keyframes slideInRight { from{opacity:0;transform:translateX(30px);} to{opacity:1;transform:translateX(0);} }
@keyframes slideInLeft { from{opacity:0;transform:translateX(-30px);} to{opacity:1;transform:translateX(0);} }

/* Card styling */
.card {
  background: white;
  padding: 22px;
  border-radius: 16px;
  box-shadow: 0 6px 22px rgba(0,0,0,0.06);
}

/* Install button */
#addHome {
  display: none;
  background: #2563eb;
  color: white;
  border: none;
  padding: 12px 16px;
  font-size: 16px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  margin-bottom: 16px;
  width: 100%;
  max-width: 260px;
}
#addHome:active { opacity: 0.7; }

/* Tab bar */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 66px;
  background: #ffffff;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 3000;
}
.bottom-nav button {
  background: none;
  border: none;
  font-size: 15px;
  font-weight: 600;
  color: #475569;
}
.bottom-nav button.active {
  color: #2563eb;
}

/* Status pills (Simon) */
.status-good {
  background:#ecfdf5; color:#0f5132;
  padding:8px 12px; border-radius:8px; font-weight:600; display:inline-block;
}
.status-bad {
  background:#ffeef0; color:#c0262e;
  padding:8px 12px; border-radius:8px; font-weight:600; display:inline-block;
}

/* Frost predictor */
.badge-good { background:#ecfdf5;color:#0f5132; }
.badge-bad { background:#ffeef0;color:#c0262e; }

/* Frost table */
table { width:100%; border-collapse:collapse; margin-top:16px; font-size:14px; }
th,td { padding:6px 8px; border-bottom:1px solid #e2e8f0; text-align:left; }

/* Settings toggles */
.toggle {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 0;
  border-bottom:1px solid #e5e7eb;
}

.toggle input {
  width:44px;
  height:24px;
  appearance:none;
  background:#cbd5e1;
  border-radius:20px;
  position:relative;
  cursor:pointer;
  outline:none;
}
.toggle input:checked { background:#2563eb; }
.toggle input:before {
  content:"";
  position:absolute;
  width:20px;
  height:20px;
  background:white;
  border-radius:50%;
  top:2px;
  left:2px;
  transition:.25s;
}
.toggle input:checked:before { transform:translateX(20px); }

/* iOS install popup */
#iosInstall {
  display:none;
  background:white;
  padding:20px;
  border-radius:16px;
  position:fixed;
  bottom:80px;
  left:50%;
  transform:translateX(-50%);
  width:85%;
  max-width:300px;
  box-shadow:0 6px 20px rgba(0,0,0,0.3);
  z-index:5000;
  text-align:center;
}
#iosInstall button {
  margin-top:14px;
  padding:10px 16px;
  border:none;
  background:#2563eb;
  color:white;
  border-radius:10px;
}

  /* -------------------- DARK MODE THEME -------------------- */
body.dark {
  background: #0b1220;
  color: #e6eef8;
}

body.dark .card {
  background: #071226;
  color: #e6eef8;
  box-shadow: 0 6px 22px rgba(0,0,0,0.4);
}

body.dark .bottom-nav {
  background: #0b1220;
  border-top-color: #1e2633;
}

body.dark .bottom-nav button {
  color: #cdd5e6;
}

body.dark .bottom-nav button.active {
  color: #60a5fa;
}

/* Status badges */
body.dark .status-good { background:#0a2f1f; color:#8ff4c8; }
body.dark .status-bad  { background:#3f0a0a; color:#ffb4b4; }

/* Frost badges */
body.dark .badge-good { background:#0a2f1f; color:#8ff4c8; }
body.dark .badge-bad  { background:#3f0a0a; color:#ffb4b4; }

/* Table */
body.dark table {
  color: #e6eef8;
}
body.dark th, 
body.dark td {
  border-bottom: 1px solid #1e2633;
}
</style>
</head>

<body>


  <!-- iOS Install Popup -->
<div id="iosInstall">
  <strong>Add to Home Screen</strong><br><br>
  Tap <span style="font-size:20px">⬆️</span> then “Add to Home Screen”.
  <br><br>
  <button onclick="dismissIOS()">Got it</button>
</div>

<!-- SIMON TAB -->
<div id="panel-simon" class="panel active slide-in-right">
  <div class="card">
    <h1>Is Simon Off?</h1>
    <button id="addHome">Install as App</button>

    <div id="todayStatus"></div>
    <div id="tomorrowStatus" style="margin-top:8px;"></div>

    <hr style="margin:20px 0;">
    <h2>Next 14 Days</h2>
    <div id="forecastList"></div>

    <h2 style="margin-top:25px;">Next Working Day</h2>
    <div id="nextWork"></div>

    <hr style="margin:20px 0;">
<button id="exportCal" style="padding:10px 16px;font-size:16px;">
  Export Simon’s Off Days (ICS)
</button>

    <hr style="margin:20px 0;">
    <h2>Select a date</h2>
    <input type="date" id="datePick" style="padding:8px;font-size:16px;width:100%;max-width:300px;">
    <button id="checkBtn" style="margin-top:10px;padding:10px 16px;font-size:16px;">Check</button>
  </div>
</div>

<!-- FROST TAB -->
<div id="panel-frost" class="panel">
  <div class="card">
    <h1>Frost Predictor</h1>

    <div id="badge" class="badge-good" style="padding:8px 12px;border-radius:8px;font-weight:600;">Checking...</div>
    <div id="advice" style="font-weight:600;margin-bottom:8px;"></div>

    <div id="explain">Fetching forecast…</div>
    <div id="meta"></div>

    <table id="hourly" hidden>
      <thead>
        <tr>
          <th>Time</th>
          <th>Temp</th>
          <th>Dew</th>
          <th>RH</th>
          <th>Wind</th>
          <th>Cloud</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- SETTINGS TAB -->
<div id="panel-settings" class="panel">
  <div class="card">
    <h1>Settings</h1>

    <div class="toggle">
      <span>Dark Mode</span>
      <input type="checkbox" id="darkToggle">
    </div>

    <div class="toggle">
      <span>Use GPS for Frost</span>
      <input type="checkbox" id="gpsToggle">
    </div>

    <div class="toggle">
      <span>Rota Pattern (future)</span>
      <select id="rotaSelect">
        <option value="6week">6-Week Pattern</option>
      </select>
    </div>

    <div class="toggle">
      <span>Reset App</span>
      <button onclick="resetApp()" style="padding:8px 12px;border-radius:8px;background:#ef4444;color:white;border:none;">Reset</button>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <button id="tab-simon" class="active">Simon Off</button>
  <button id="tab-frost">Frost</button>
  <button id="tab-settings">Settings</button>
</nav>

<script>
/* -------------------- TAB SWITCHING -------------------- */
const panels = {
  simon: document.getElementById("panel-simon"),
  frost: document.getElementById("panel-frost"),
  settings: document.getElementById("panel-settings")
};
const tabs = {
  simon: document.getElementById("tab-simon"),
  frost: document.getElementById("tab-frost"),
  settings: document.getElementById("tab-settings")
};

function showTab(tab){
  for(const p in panels) panels[p].classList.remove("active");
  for(const t in tabs) tabs[t].classList.remove("active");

  panels[tab].classList.add("active","slide-in-right");
  tabs[tab].classList.add("active");
}

tabs.simon.onclick = ()=>showTab("simon");
tabs.frost.onclick = ()=>showTab("frost");
tabs.settings.onclick = ()=>showTab("settings");

/* -------------------- DARK MODE -------------------- */
const darkToggle=document.getElementById("darkToggle");
if(localStorage.getItem("darkMode")==="1"){
  document.body.classList.add("dark");
  darkToggle.checked=true;
}
darkToggle.onchange=()=>{
  if(darkToggle.checked){
    document.body.classList.add("dark");
    localStorage.setItem("darkMode","1");
  } else {
    document.body.classList.remove("dark");
    localStorage.setItem("darkMode","0");
  }
};

/* -------------------- iOS INSTALL POPUP -------------------- */
function isIOS(){
  return /iphone|ipad|ipod/i.test(navigator.userAgent);
}
function isStandalone(){
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
}
function dismissIOS(){
  document.getElementById("iosInstall").style.display="none";
  localStorage.setItem("iosDismiss","1");
}

if(isIOS() && !isStandalone() && !localStorage.getItem("iosDismiss")){
  setTimeout(()=>{ document.getElementById("iosInstall").style.display="block"; }, 1200);
}

/* -------------------- PWA INSTALL BUTTON -------------------- */
let deferredPrompt;
const addHomeBtn=document.getElementById("addHome");

if(localStorage.getItem("pwaInstalled")==="yes"){
  addHomeBtn.style.display="none";
}

window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  if(localStorage.getItem("pwaInstalled")!=="yes"){
    addHomeBtn.style.display="block";
  }
});

addHomeBtn.onclick = async () => {
  if(!deferredPrompt){
    alert("Install not available yet.");
    return;
  }
  deferredPrompt.prompt();
  const choice=await deferredPrompt.userChoice;
  if(choice.outcome==="accepted"){
    localStorage.setItem("pwaInstalled","yes");
    addHomeBtn.style.display="none";
  }
  deferredPrompt=null;
};

window.addEventListener("appinstalled", ()=>{
  localStorage.setItem("pwaInstalled","yes");
  addHomeBtn.style.display="none";
});

/* -------------------- RESET APP -------------------- */
function resetApp(){
  localStorage.clear();
  location.reload();
}

/* -------------------- SIMON ROTA -------------------- */
const rotaBase=new Date("2025-11-29");
const offOffsets = new Set([
  0, 1, 2, 3,      // 29 Nov – 2 Dec 2025
  9, 10,          // 8–9 Dec
  16,             // 15 Dec
  21, 22,         // 20–21 Dec
  27, 28, 29,     // 26–28 Dec
  34, 35, 36      // 2–4 Jan 2026 (and repeats every 42 days)
]);
  
function isSimonOffOn(date){
  const d=new Date(date.getFullYear(),date.getMonth(),date.getDate());
  const diff=Math.floor((d-rotaBase)/86400000);
  return diff>=0 && offOffsets.has(diff % 42);
}
function formatStatus(isOff){
  return isOff?`<div class="status-bad">Simon is OFF</div>`:`<div class="status-good">Simon is working</div>`;
}
function formatDate(d){
  return d.toLocaleDateString("en-GB",{weekday:"short",day:"2-digit",month:"short"});
}

const today=new Date();
const tomorrow=new Date(); tomorrow.setDate(today.getDate()+1);

document.getElementById("todayStatus").innerHTML = `<strong>Today:</strong><br>${formatStatus(isSimonOffOn(today))}`;
document.getElementById("tomorrowStatus").innerHTML = `<strong>Tomorrow:</strong><br>${formatStatus(isSimonOffOn(tomorrow))}`;

/* Forecast */
const forecastList=document.getElementById("forecastList");
for(let i=0;i<14;i++){
  const d=new Date(); d.setDate(today.getDate()+i);
  const off=isSimonOffOn(d);
  const row=document.createElement("div");
  row.className="forecast-item "+(off?"off":"work");
  row.textContent=`${formatDate(d)} — ${off?"OFF":"Working"}`;
  forecastList.appendChild(row);
}

/* Next working day */
(function(){
  for(let i=1;i<200;i++){
    const d=new Date(); d.setDate(today.getDate()+i);
    if(!isSimonOffOn(d)){
      document.getElementById("nextWork").textContent =
        `${formatDate(d)} — Simon is working`;
      return;
    }
  }
})();

/* Date picker */
document.getElementById("checkBtn").onclick = ()=>{
  const val=document.getElementById("datePick").value;
  if(!val) return;
  const d=new Date(val);
  alert(`${formatDate(d)} — ${isSimonOffOn(d)?"Simon is OFF":"Simon is working"}`);
};

/* -------------------- FROST PREDICTOR -------------------- */
(async function(){
  const lat = 52.95;
  const lon = -1.15;
  const tz = "Europe/London";

  const badge=document.getElementById("badge");
  const advice=document.getElementById("advice");
  const explain=document.getElementById("explain");
  const meta=document.getElementById("meta");
  const hourlyTable=document.getElementById("hourly");
  const tbody=hourlyTable.querySelector("tbody");

  function setBadge(text, good){
    badge.textContent=text;
    badge.className = good?"badge-good":"badge-bad";
  }

  try {
    explain.textContent="Preparing dates…";

    const now=new Date();
    const fmt=new Intl.DateTimeFormat("en-GB",{
      timeZone:tz,
      year:"numeric",month:"2-digit",day:"2-digit",
      hour:"2-digit",minute:"2-digit",hour12:false
    });
    const p=Object.fromEntries(fmt.formatToParts(now).map(x=>[x.type,x.value]));

    let y=+p.year, m=+p.month, d=+p.day, h=+p.hour;
    if(h>=6){
      const t=new Date(Date.UTC(y,m-1,d));
      t.setUTCDate(t.getUTCDate()+1);
      y=t.getUTCFullYear(); m=t.getUTCMonth()+1; d=t.getUTCDate();
    }

    const pad=n=>String(n).padStart(2,"0");
    const dateStr=`${y}-${pad(m)}-${pad(d)}`;

    explain.textContent="Fetching forecast…";

    const resp=await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
      `&hourly=temperature_2m,dewpoint_2m,relative_humidity_2m,cloud_cover,wind_speed_10m`+
      `&timezone=${encodeURIComponent(tz)}&start_date=${dateStr}&end_date=${dateStr}`
    );
    const data=await resp.json();

    const times=data.hourly.time;
    const temps=data.hourly.temperature_2m;
    const dews=data.hourly.dewpoint_2m;
    const hums=data.hourly.relative_humidity_2m;
    const winds=data.hourly.wind_speed_10m;
    const clouds=data.hourly.cloud_cover;

    const overnight=[];
    for(let i=0;i<times.length;i++){
      if(times[i].startsWith(dateStr+"T")){
        const hr=+times[i].slice(11,13);
        if(hr>=0 && hr<=5){
          overnight.push({
            time:times[i],
            temp:temps[i],
            dew:dews[i],
            rh:hums[i],
            wind:winds[i],
            cloud:clouds[i]
          });
        }
      }
    }

    tbody.innerHTML="";
    hourlyTable.hidden=false;

    let coldest=null;
    overnight.forEach(o=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${o.time.replace("T"," ")}</td>
        <td>${o.temp.toFixed(1)}</td>
        <td>${o.dew.toFixed(1)}</td>
        <td>${o.rh}</td>
        <td>${o.wind.toFixed(1)}</td>
        <td>${o.cloud}</td>
      `;
      tbody.appendChild(tr);
      if(!coldest || o.temp < coldest.temp) coldest=o;
    });

    const risk =
      coldest.temp <= 2 &&
      coldest.temp - coldest.dew <= 1 &&
      coldest.wind <= 3 &&
      coldest.cloud <= 40;

    if(risk){
      setBadge("Frost Likely", false);
      advice.textContent="Put the frost cover on.";
    } else {
      setBadge("No Frost Expected", true);
      advice.textContent="Frost unlikely tonight.";
    }

    meta.textContent=`Coldest hour: ${coldest.time.replace("T"," ")}`;
    explain.textContent=`Checked 00:00–05:59`;

  } catch(err){
    setBadge("Error", false);
    explain.textContent=err.message;
  }
})();

  /* -------------------- ICS EXPORT -------------------- */
document.getElementById("exportCal").onclick = exportCalendar;

function exportCalendar() {
  // Generate next 180 days
  const events = [];
  for (let i = 0; i < 180; i++) {
    const d = new Date();
    d.setDate(d.getDate() + i);
    if (isSimonOffOn(d)) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");

      const dateStr = `${y}${m}${day}`;
      events.push(
`BEGIN:VEVENT
DTSTART;VALUE=DATE:${dateStr}
DTEND;VALUE=DATE:${dateStr}
SUMMARY:Simon is OFF
END:VEVENT`
      );
    }
  }

  const icsContent =
`BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
METHOD:PUBLISH
${events.join("\n")}
END:VCALENDAR`;

  const blob = new Blob([icsContent], { type: "text/calendar" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "simon-off-days.ics";
  a.click();

  URL.revokeObjectURL(url);
    }
</script>

</body>
</html>
