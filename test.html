<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Frost Predictor — Nottingham</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
body {
  max-width: 820px;
  margin: 0 auto;
  background: #f8fafc;
  color: #0f172a;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  overflow-x: hidden;
}

/* Install button */
#addHome {
  display:none;
  background:#2563eb;
  color:white;
  border:none;
  padding:12px 16px;
  font-size:16px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  margin-bottom:16px;
  width:100%;
  max-width:260px;
}
#addHome:active { opacity:0.7; }

/* Slide animation */
#slide {
  position: relative;
  padding: 32px 20px 100px 20px;
  animation-duration: .35s;
  animation-timing-function: ease-out;
}
.slide-in-right { animation-name: slideInRight; }
.slide-in-left  { animation-name: slideInLeft; }
@keyframes slideInRight { from{opacity:0;transform:translateX(40px);} to{opacity:1;transform:translateX(0);} }
@keyframes slideInLeft  { from{opacity:0;transform:translateX(-40px);} to{opacity:1;transform:translateX(0);} }

.card {
  background: white;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
}

/* Results */
#badge {
  display:inline-block;
  padding:6px 12px;
  border-radius:8px;
  font-weight:600;
  margin-bottom:10px;
}
.badge-good { background:#ecfdf5; color:#0f5132; }
.badge-bad  { background:#ffeef0; color:#c0262e; }

table {
  width:100%;
  border-collapse:collapse;
  margin-top:16px;
  font-size:14px;
}
th,td {
  padding:6px 8px;
  border-bottom:1px solid #e2e8f0;
  text-align:left;
}

/* Fixed bottom navigation */
.bottom-nav {
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#ffffff;
  border-top:1px solid #e5e7eb;
  display:flex;
  justify-content:space-around;
  padding:12px 0;
  font-size:16px;
  z-index:3000;
}
.bottom-nav a {
  text-decoration:none;
  color:#0f172a;
  font-weight:600;
}
.bottom-nav a.active { color:#2563eb; }
</style>
</head>

<body>

<div id="slide" class="slide-in-left">

<div class="card">
  <h1>Will your car frost up tomorrow?</h1>

  <button id="addHome">Install as App</button>

  <div id="badge" class="badge-good">Checking...</div>
  <div id="advice" style="font-weight:600;margin-bottom:8px;"></div>

  <div id="explain">Fetching forecast…</div>
  <div id="meta"></div>

  <table id="hourly" hidden>
    <thead>
      <tr>
        <th>Time</th>
        <th>Temp °C</th>
        <th>Dew °C</th>
        <th>RH %</th>
        <th>Wind</th>
        <th>Cloud %</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer style="margin-top:16px;font-size:13px;color:#64748b;"> :) </footer>
</div>

</div>

<!-- Navigation -->
<nav class="bottom-nav">
  <a href="index.html" id="nav-simon">Is Simon Off?</a>
  <a href="test.html" id="nav-frost" class="active">Frost</a>
</nav>

<script>
/* Navigation slide animation */
function handleNavClick(e, dir, href){
  e.preventDefault();
  const slide=document.getElementById("slide");
  slide.className = dir==="left" ? "slide-in-left" : "slide-in-right";
  setTimeout(()=>window.location.href=href,200);
}
document.getElementById("nav-simon").onclick = e => handleNavClick(e,"right","index.html");
document.getElementById("nav-frost").onclick = e => handleNavClick(e,"left","test.html");
</script>

<!-- PWA Install -->
<script>
let deferredPrompt;
const addHomeBtn=document.getElementById("addHome");

if(localStorage.getItem("pwaInstalled")==="yes"){
  addHomeBtn.style.display="none";
}

window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  if(localStorage.getItem("pwaInstalled")!=="yes"){
    addHomeBtn.style.display="block";
  }
});

addHomeBtn.addEventListener("click",async()=>{
  if(!deferredPrompt){
    alert("Install not available yet.");
    return;
  }
  deferredPrompt.prompt();
  const choice=await deferredPrompt.userChoice;
  if(choice.outcome==="accepted"){
    localStorage.setItem("pwaInstalled","yes");
    addHomeBtn.style.display="none";
  }
  deferredPrompt=null;
});

window.addEventListener("appinstalled",()=>{
  localStorage.setItem("pwaInstalled","yes");
  addHomeBtn.style.display="none";
});
</script>

<!-- Service Worker -->
<script>
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>navigator.serviceWorker.register("sw.js"));
}
</script>

<!-- Frost Predictor Logic -->
<script>
(async function(){
  const lat=52.95, lon=-1.15, tz="Europe/London";

  const badge=document.getElementById("badge");
  const advice=document.getElementById("advice");
  const explain=document.getElementById("explain");
  const meta=document.getElementById("meta");
  const hourlyTable=document.getElementById("hourly");
  const tbody=hourlyTable.querySelector("tbody");

  function setBadge(txt, good){
    badge.textContent=txt;
    badge.className = good ? "badge-good" : "badge-bad";
  }

  try {
    explain.textContent="Preparing dates…";

    const now=new Date();
    const formatter=new Intl.DateTimeFormat("en-GB",{
      timeZone:tz,
      year:"numeric",month:"2-digit",day:"2-digit",
      hour:"2-digit",minute:"2-digit",hour12:false
    });

    const parts=Object.fromEntries(formatter.formatToParts(now).map(p=>[p.type,p.value]));

    let y=+parts.year, m=+parts.month, d=+parts.day, hour=+parts.hour;

    if(hour>=6){
      const t=new Date(Date.UTC(y,m-1,d));
      t.setUTCDate(t.getUTCDate()+1);
      y=t.getUTCFullYear(); m=t.getUTCMonth()+1; d=t.getUTCDate();
    }

    const pad=n=>String(n).padStart(2,"0");
    const dateStr=`${y}-${pad(m)}-${pad(d)}`;

    explain.textContent="Fetching forecast…";

    const resp=await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`+
      `&hourly=temperature_2m,dewpoint_2m,relative_humidity_2m,cloud_cover,wind_speed_10m`+
      `&timezone=${encodeURIComponent(tz)}&start_date=${dateStr}&end_date=${dateStr}`
    );
    const data=await resp.json();

    const times=data.hourly.time;
    const temps=data.hourly.temperature_2m;
    const dews=data.hourly.dewpoint_2m;
    const hums=data.hourly.relative_humidity_2m;
    const winds=data.hourly.wind_speed_10m;
    const clouds=data.hourly.cloud_cover;

    const overnight=[];
    for(let i=0;i<times.length;i++){
      if(times[i].startsWith(dateStr+"T")){
        const h=+times[i].slice(11,13);
        if(h>=0 && h<=5){
          overnight.push({
            time:times[i],
            temp:temps[i],
            dew:dews[i],
            rh:hums[i],
            wind:winds[i],
            cloud:clouds[i]
          });
        }
      }
    }

    tbody.innerHTML="";
    hourlyTable.hidden=false;

    let coldest=null;
    overnight.forEach(o=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${o.time.replace("T"," ")}</td>
        <td>${o.temp.toFixed(1)}</td>
        <td>${o.dew.toFixed(1)}</td>
        <td>${o.rh}</td>
        <td>${o.wind.toFixed(1)}</td>
        <td>${o.cloud}</td>
      `;
      tbody.appendChild(tr);
      if(!coldest || o.temp < coldest.temp) coldest=o;
    });

    const frostLikely =
      coldest.temp <= 2 &&
      coldest.temp - coldest.dew <= 1 &&
      coldest.wind <= 3 &&
      coldest.cloud <= 40;

    if(frostLikely){
      setBadge("Frost Likely", false);
      advice.textContent="Put the frost cover on.";
    } else {
      setBadge("No Frost Expected", true);
      advice.textContent="Frost unlikely tonight.";
    }

    meta.textContent=`Coldest hour: ${coldest.time.replace("T"," ")}`;
    explain.textContent=`Checked 00:00–05:59`;

  } catch(err){
    setBadge("Error", false);
    explain.textContent=err.message;
  }
})();
</script>

</body>
</html>
